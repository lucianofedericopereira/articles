{% capture _unused %}
{% assign meta = site.meta %}
{% assign domain = "https://" | append: site.base.url %}
{% assign folder = domain | append: "/" | append: site.base.folder %}
{% assign asset = folder | append: "/assets" %}
{% assign image = asset | append: "/images" %}
{% assign font = asset | append: "/fonts" %}
{% assign css = asset | append: "/css" %}
{% assign js = asset | append: "/js" %}
{% assign icon = image | append: "/favicon.ico" %}
{% endcapture %}<!DOCTYPE html>
<html lang="{{ meta.locale | default: 'en' }}">
{%- include components/head.html -%}
<body>
    <div id="translate"></div>
    <input type="checkbox" aria-expanded="false" id="menu" autocomplete='off'>
    <header>
        <a tabindex="0" href="{{folder}}" id="logo-link">
            <div id="logo" class="notranslate">
                <img id="logo-pic" width="36px" height="36px" src="{{icon}}" alt="logo">
                {{meta.title}}
            </div>
            <div id="slogan">{{meta.tagline}}</div>
        </a>
    </header>
    <label for="menu" aria-label="Toggle Menu" id="menu-label">
        <div class="border" aria-hidden="true"></div>
        <div class="icon icon-menu" aria-hidden="true"></div>
    </label>
    <aside>
        {%- include components/aside.html -%}
    </aside>
    <main>
        {% if page.toc %}<label for="toc"><div class="icon icon-toc" aria-label="Show Table of Contents"></div></label>{% endif %}
        <h1>{{ page.title | capitalize }}</h1>
        <input type="checkbox" aria-expanded="false" id="toc" autocomplete='off'>
        <div id="index"><div id="reading-time"></div><div id="chapters"></div></div>
        {{ content }}
        {% if page.comments and site.utteranc.repo %}<div id="comments">
            <h3>Comments</h3>
            <div id="comments-utteranc" class="notranslate"></div>
        </div>{% endif %}
    </main>

<script type="module" defer>
    import lunr from 'https://cdn.jsdelivr.net/npm/lunr@{{ site.version.lunr }}/+esm';


    async function searchHandler(lunrInstance) {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const metaTag = document.querySelector('meta[name="search"]');
            const mainHeader = document.getElementById('main-header');
            if (!searchInput || !searchResults || !metaTag?.content) return;

            let currentInput = '';
            let currentSearchIndex = 0;

            try {
                const response = await fetch(metaTag.content);
                if (!response.ok) throw new Error(`Failed to load search data: ${response.status}`);
                const docs = await response.json();
                lunrInstance.tokenizer.separator = /[\s/]+/;

                const index = lunrInstance(function () {
                    this.ref('id');
                    this.field('title', { boost: 200 });
                    this.field('content', { boost: 2 });
                    this.metadataWhitelist = ['position'];
                    Object.keys(docs).forEach((key) => {
                        this.add({
                            id: key,
                            title: docs[key].title,
                            content: docs[key].content,
                        });
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        mainHeader?.classList.add('nav-open');
                        searchInput.focus();
                    }
                });

                const showSearch = () => document.documentElement.classList.add('search-active');
                const hideSearch = () => {
                    document.documentElement.classList.remove('search-active');
                    searchInput.value = ''; // ✅ Clear input field when hiding search
                    searchResults.innerHTML = ''; // ✅ Clear results
                };

                searchInput.addEventListener('input', () => {
                    const input = searchInput.value.trim();

                    if (input.length === 0) { // ✅ Clears results only when empty, not when typing single chars
                        hideSearch();
                        return;
                    }

                    if (input === currentInput) return;
                    currentInput = input;
                    currentSearchIndex++;
                    searchResults.innerHTML = '';

                    showSearch();

                    let results = index.query((query) => {
                        const tokens = lunrInstance.tokenizer(input);
                        query.term(tokens, { boost: 10 });
                        query.term(tokens, { wildcard: lunrInstance.Query.wildcard.TRAILING });
                    });

                    if (!results.length && input.length > 2) {
                        const tokens = lunrInstance.tokenizer(input).filter((token) => token.str.length < 20);
                        if (tokens.length) {
                            results.push(...index.query((query) => {
                                query.term(tokens, { editDistance: Math.round(Math.sqrt(input.length / 2 - 1)) });
                            }));
                        }
                    }

                    if (results.length === 0) {
                        searchResults.innerHTML = `<div class="search-no-result">No results found</div>`;
                    } else {
                        const resultsList = document.createElement('ul');
                        resultsList.classList.add('search-results-list');
                        searchResults.appendChild(resultsList);
                        addResults(resultsList, results, 0, 10, 100, currentSearchIndex, docs);
                    }
                });

                // ✅ Improved search reset when input field is hidden
                const resetSearch = () => {
                    searchInput.value = ''; // ✅ Clears input field
                    searchResults.innerHTML = ''; // ✅ Clears search results
                };

                const observer = new MutationObserver(() => {
                    if (window.getComputedStyle(searchInput).display === 'none') {
                        resetSearch(); // ✅ Clears input when hidden
                    }
                });
                observer.observe(searchInput, { attributes: true, attributeFilter: ['style'] });

                // ✅ Also clear search when focus is lost
                searchInput.addEventListener('focusout', () => resetSearch());

                // ✅ Clear search when a result is clicked
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.search-result')) {
                        resetSearch(); // ✅ Clears search results after clicking a result
                    }
                });

                // ✅ ESC key support to clear search
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        resetSearch(); // ✅ Clears input and search results when pressing ESC
                    }
                });

                const addResults = (resultsList, results, start, batchSize, batchMillis, searchIndex, docs) => {
                    if (searchIndex !== currentSearchIndex) return; // Abort if search index changed
                    for (let i = start; i < Math.min(start + batchSize, results.length); i++) {
                        addResult(resultsList, results[i], docs);
                    }
                    if (start + batchSize < results.length) {
                        setTimeout(() => addResults(resultsList, results, start + batchSize, batchSize, batchMillis, searchIndex, docs), batchMillis);
                    }
                };

                const addResult = (resultsList, result, docs) => {
                    const doc = docs[result.ref];
                    const resultsListItem = document.createElement('li');
                    resultsListItem.classList.add('search-results-list-item');
                    resultsList.appendChild(resultsListItem);

                    const resultLink = document.createElement('a');
                    resultLink.classList.add('search-result');
                    resultLink.href = doc.url;
                    resultsListItem.appendChild(resultLink);

                    const resultTitle = document.createElement('div');
                    resultTitle.classList.add('search-result-title');
                    resultTitle.textContent = doc.title;
                    resultLink.appendChild(resultTitle);

                    // ✅ Correctly nested result preview inside `.search-result`
                    if (doc.content) {
                        const resultPreviews = document.createElement('div');
                        resultPreviews.classList.add('search-result-previews');
                        resultLink.appendChild(resultPreviews);

                        const previewText = doc.content.slice(0, 100);
                        const resultPreview = document.createElement('div');
                        resultPreview.classList.add('search-result-preview');
                        resultPreview.textContent = `${previewText}…`;
                        resultPreviews.appendChild(resultPreview);
                    }
                };

            } catch (error) {
                console.error('Error loading search data:', error);
            }
        }


/*
     async function searchHandler(lunrInstance) {
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const metaTag = document.querySelector('meta[name="search"]');
        const mainHeader = document.getElementById('main-header');
        if (!searchInput || !searchResults || !metaTag?.content) return;

        let currentInput = '';
        let currentSearchIndex = 0;

        try {
            const response = await fetch(metaTag.content);
            if (!response.ok) throw new Error(`Failed to load search data: ${response.status}`);
            const docs = await response.json();
            lunrInstance.tokenizer.separator = /[\s/]+/;

            const index = lunrInstance(function () {
                this.ref('id');
                this.field('title', { boost: 200 });
                this.field('content', { boost: 2 });
                this.metadataWhitelist = ['position'];
                Object.keys(docs).forEach((key) => {
                    this.add({
                        id: key,
                        title: docs[key].title,
                        content: docs[key].content,
                    });
                });
            });

            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    mainHeader?.classList.add('nav-open');
                    searchInput.focus();
                }
            });

            const showSearch = () => document.documentElement.classList.add('search-active');
            const hideSearch = () => document.documentElement.classList.remove('search-active');

            searchInput.addEventListener('input', () => {
                const input = searchInput.value.trim();

                if (input.length < 2) { // 🔥 Ensure at least 2 keystrokes before searching
                    hideSearch();
                    searchResults.innerHTML = ''; // ✅ Fix: Clear results when deleting characters
                    return;
                }

                if (input === currentInput) return;
                currentInput = input;
                currentSearchIndex++;
                searchResults.innerHTML = '';

                showSearch();

                let results = index.query((query) => {
                    const tokens = lunrInstance.tokenizer(input);
                    query.term(tokens, { boost: 10 });
                    query.term(tokens, { wildcard: lunrInstance.Query.wildcard.TRAILING });
                });

                if (!results.length && input.length > 2) {
                    const tokens = lunrInstance.tokenizer(input).filter((token) => token.str.length < 20);
                    if (tokens.length) {
                        results.push(...index.query((query) => {
                            query.term(tokens, { editDistance: Math.round(Math.sqrt(input.length / 2 - 1)) });
                        }));
                    }
                }

                if (results.length === 0) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.classList.add('search-no-result');
                    noResultsDiv.textContent = 'No results found';
                    searchResults.appendChild(noResultsDiv);
                } else {
                    const resultsList = document.createElement('ul');
                    resultsList.classList.add('search-results-list');
                    searchResults.appendChild(resultsList);
                    addResults(resultsList, results, 0, 10, 100, currentSearchIndex, docs);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    searchResults.innerHTML = '';
                    hideSearch();
                }
            });



            const addResults = (resultsList, results, start, batchSize, batchMillis, searchIndex, docs) => {
                if (searchIndex !== currentSearchIndex) return;
                for (let i = start; i < Math.min(start + batchSize, results.length); i++) {
                    addResult(resultsList, results[i], docs);
                }
                if (start + batchSize < results.length) {
                    setTimeout(() => addResults(resultsList, results, start + batchSize, batchSize, batchMillis, searchIndex, docs), batchMillis);
                }
            };

            const addResult = (resultsList, result, docs) => {
                const doc = docs[result.ref];
                const resultsListItem = document.createElement('li');
                resultsListItem.classList.add('search-results-list-item');
                resultsList.appendChild(resultsListItem);

                const resultLink = document.createElement('a');
                resultLink.classList.add('search-result');
                resultLink.href = doc.url;
                resultsListItem.appendChild(resultLink);

                const resultTitle = document.createElement('div');
                resultTitle.classList.add('search-result-title');
                resultTitle.textContent = doc.title;
                resultLink.appendChild(resultTitle);

                if (doc.content) {
                    const resultPreviews = document.createElement('div');
                    resultPreviews.classList.add('search-result-previews');
                    resultLink.appendChild(resultPreviews);
                    const previewText = doc.content.slice(0, 100);
                    const resultPreview = document.createElement('div');
                    resultPreview.classList.add('search-result-preview');
                    resultPreview.textContent = `${previewText}…`;
                    resultPreviews.appendChild(resultPreview);
                }
            };
        } catch (error) {
            console.error('Error loading search data:', error);
        }
    }

*/



/*
    async function searchHandler(lunrInstance) {
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const metaTag = document.querySelector('meta[name="search"]');
        const mainHeader = document.getElementById('main-header');
        if (!searchInput || !searchResults || !metaTag?.content) return;

        let currentInput = '';
        let currentSearchIndex = 0;

        try {
            const response = await fetch(metaTag.content);
            if (!response.ok) throw new Error(`Failed to load search data: ${response.status}`);
            const docs = await response.json();
            lunrInstance.tokenizer.separator = /[\s/]+/;
            const index = lunrInstance(function () {
                this.ref('id');
                this.field('title', { boost: 200 });
                this.field('content', { boost: 2 });
                this.metadataWhitelist = ['position'];
                Object.keys(docs).forEach((key) => {
                    this.add({
                        id: key,
                        title: docs[key].title,
                        content: docs[key].content,
                    });
                });
            });
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    mainHeader?.classList.add('nav-open');
                    searchInput.focus();
                }
            });
            const showSearch = () => document.documentElement.classList.add('search-active');
            const hideSearch = () => document.documentElement.classList.remove('search-active');
            searchInput.addEventListener('input', () => {
                const input = searchInput.value.trim();
                if (input === currentInput) return;
                currentInput = input;
                currentSearchIndex++;
                searchResults.innerHTML = '';
                if (!input) {
                    hideSearch();
                    return;
                }
                showSearch();
                let results = index.query((query) => {
                    const tokens = lunrInstance.tokenizer(input);
                    query.term(tokens, { boost: 10 });
                    query.term(tokens, { wildcard: lunrInstance.Query.wildcard.TRAILING });
                });
                if (!results.length && input.length > 2) {
                    const tokens = lunrInstance.tokenizer(input).filter((token) => token.str.length < 20);
                    if (tokens.length) {
                        results.push(...index.query((query) => {
                            query.term(tokens, { editDistance: Math.round(Math.sqrt(input.length / 2 - 1)) });
                        }));
                    }
                }
                if (results.length === 0) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.classList.add('search-no-result');
                    noResultsDiv.textContent = 'No results found';
                    searchResults.appendChild(noResultsDiv);
                } else {
                    const resultsList = document.createElement('ul');
                    resultsList.classList.add('search-results-list');
                    searchResults.appendChild(resultsList);
                    addResults(resultsList, results, 0, 10, 100, currentSearchIndex, docs);
                }
            });
            const addResults = (resultsList, results, start, batchSize, batchMillis, searchIndex, docs) => {
                if (searchIndex !== currentSearchIndex) return; // Abort if search index changed
                for (let i = start; i < Math.min(start + batchSize, results.length); i++) {
                    addResult(resultsList, results[i], docs);
                }
                if (start + batchSize < results.length) {
                    setTimeout(() => addResults(resultsList, results, start + batchSize, batchSize, batchMillis, searchIndex, docs), batchMillis);
                }
            };
            const addResult = (resultsList, result, docs) => {
                const doc = docs[result.ref];
                const resultsListItem = document.createElement('li');
                resultsListItem.classList.add('search-results-list-item');
                resultsList.appendChild(resultsListItem);
                const resultLink = document.createElement('a');
                resultLink.classList.add('search-result');
                resultLink.href = doc.url;
                resultsListItem.appendChild(resultLink);
                const resultTitle = document.createElement('div');
                resultTitle.classList.add('search-result-title');
                resultTitle.textContent = doc.title;
                resultLink.appendChild(resultTitle);
                if (doc.content) {
                    const resultPreviews = document.createElement('div');
                    resultPreviews.classList.add('search-result-previews');
                    resultLink.appendChild(resultPreviews);
                    const previewText = doc.content.slice(0, 100);
                    const resultPreview = document.createElement('div');
                    resultPreview.classList.add('search-result-preview');
                    resultPreview.textContent = `${previewText}…`;
                    resultPreviews.appendChild(resultPreview);
                }
            };
        } catch (error) {
            console.error('Error loading search data:', error);
        }
    }
*/


    searchHandler(lunr);


</script>



    <script  src="{{js}}/codecraft.js" async></script>
</body>
</html>