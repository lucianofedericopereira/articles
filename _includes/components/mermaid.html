{% if site.version.mermaid %}
<script type="module" defer>
  document.addEventListener('DOMContentLoaded', () => {
    const mermaidElements = document.querySelectorAll('.language-mermaid');
    if (mermaidElements.length > 0) {
      import('https://cdn.jsdelivr.net/npm/mermaid@{{ site.version.mermaid }}/+esm')
        .then(mermaid => {
          mermaid.initialize({});
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                mermaid.run({ querySelector: '.language-mermaid' });
                observer.disconnect();
              }
            });
          });
          mermaidElements.forEach(el => observer.observe(el));
        })
        .catch(error => {
          console.error('Failed to load Mermaid.js:', error);
        });
    }
  });
</script>
{% endif %}